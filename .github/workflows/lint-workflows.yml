name: Lint workflows (forbidden packaging flags)

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Forbid -AllowBinaries in workflows
        shell: pwsh
        run: |
          # Fail if PackagePlugin.ps1 is called with -AllowBinaries (violates CI policy)
          $violations = @()
          foreach ($file in Get-ChildItem ".github/workflows/*.yml") {
            $lines = @(Get-Content $file -Encoding UTF8)
            $inRunBlock = $false
            for ($i = 0; $i -lt $lines.Count; $i++) {
              $line = $lines[$i]
              if ($line -match '^\s+run:\s*[\|\>]') { $inRunBlock = $true }
              if ($inRunBlock -and $line -match '^\s+- ') { $inRunBlock = $false }
              # Only flag actual script invocation lines that call PackagePlugin.ps1 with -AllowBinaries
              if ($inRunBlock -and $line -match '^\s+\.\\\Scripts\\PackagePlugin\.ps1.*-AllowBinaries') {
                $violations += "$($file.Name):$($i+1)"
              }
            }
          }
          if ($violations) {
            $violations | ForEach-Object { Write-Error "Forbidden: $_" }
            throw "CI forbids PackagePlugin.ps1 with -AllowBinaries"
          }
          Write-Host "OK: Workflows do not call PackagePlugin.ps1 with -AllowBinaries"